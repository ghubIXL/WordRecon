<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scenario Sentence Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        .input-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #334155;
        }
        input[type="text"], select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            font-size: 1rem;
            color: #334155;
            background-color: #f8fafc;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 0.5rem;
        }
        button:active {
            transform: translateY(1px);
        }
        .btn-generate {
            background-color: #6366f1;
            color: #ffffff;
        }
        .btn-generate:hover {
            background-color: #4f46e5;
        }
        .btn-show {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .btn-show:hover {
            background-color: #2563eb;
        }
        .btn-repeat {
            background-color: #10b981;
            color: #ffffff;
        }
        .btn-repeat:hover {
            background-color: #059669;
        }
        .btn-score {
            background-color: #f59e0b;
            color: #ffffff;
        }
        .btn-score:hover {
            background-color: #d97706;
        }
        .message {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 500;
            color: #1f2937;
            background-color: #e2e8f0;
            min-height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .generated-sentence {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border: 1px dashed #94a3b8;
            border-radius: 0.75rem;
            background-color: #f1f5f9;
            color: #1e293b;
            font-size: 1.1rem;
            line-height: 1.6;
            text-align: center;
            word-wrap: break-word;
        }
        .hidden {
            display: none;
        }
        .score-display {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            color: #4338ca;
            background-color: #e0e7ff;
            text-align: center;
            border: 1px solid #a5b4fc;
        }
        .timer-display {
            margin-top: 1rem;
            font-size: 1.2rem;
            font-weight: 700;
            color: #1d4ed8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Scenario Sentence Generator</h1>

        <div class="input-group">
            <label for="prompt">Scenario Prompt:</label>
            <input type="text" id="prompt" placeholder="e.g., family discussing fast food orders">
        </div>

        <div class="input-group">
            <label for="wordCount">Max Words:</label>
            <select id="wordCount">
                <option value="10">Up to 10 words</option>
                <option value="15">Up to 15 words</option>
                <option value="20">Up to 20 words</option>
                <option value="25">Up to 25 words</option>
                <option value="30">Up to 30 words</option>
            </select>
        </div>

        <div class="input-group">
            <label for="vocabularyLevel">Vocabulary Level:</label>
            <select id="vocabularyLevel">
                <option value="Kid">Kid</option>
                <option value="K6">K6 (Elementary School)</option>
                <option value="K12">K12 (High School)</option>
                <option value="Adult">Adult</option>
            </select>
        </div>

        <div class="input-group">
            <label for="voiceSelect">Select Voice:</label>
            <select id="voiceSelect">
                </select>
        </div>

        <div class="flex justify-center mt-6">
            <button id="generateBtn" class="btn-generate">Generate</button>
            <button id="repeatBtn" class="btn-repeat">Repeat</button>
            <button id="showBtn" class="btn-show">Show</button>
            <button id="scoreBtn" class="btn-score">Score</button>
        </div>

        <div id="message" class="message">
            Enter your scenario and preferences, then click 'Generate'.
        </div>

        <div id="scoreDisplay" class="score-display hidden">
            </div>

        <div id="generatedSentence" class="generated-sentence hidden">
            </div>

        <div id="timerDisplay" class="timer-display">
            00:00
        </div>
    </div>

    <script type="module">
        // Get references to DOM elements
        const promptInput = document.getElementById('prompt');
        const wordCountSelect = document.getElementById('wordCount');
        const vocabularyLevelSelect = document.getElementById('vocabularyLevel');
        const voiceSelect = document.getElementById('voiceSelect');
        const generateBtn = document.getElementById('generateBtn');
        const repeatBtn = document.getElementById('repeatBtn');
        const showBtn = document.getElementById('showBtn');
        const scoreBtn = document.getElementById('scoreBtn');
        const messageDiv = document.getElementById('message');
        const scoreDisplayDiv = document.getElementById('scoreDisplay');
        const generatedSentenceDiv = document.getElementById('generatedSentence');
        const timerDisplayDiv = document.getElementById('timerDisplay');

        let currentSentence = '';
        let currentScore = 0;
        let generateCount = 0;
        let timerInterval;
        let startTime;

        // Function to update the message display
        function updateMessage(text, isError = false) {
            messageDiv.textContent = text;
            messageDiv.style.backgroundColor = isError ? '#fee2e2' : '#e2e8f0';
            messageDiv.style.color = isError ? '#dc2626' : '#1f2937';
        }

        // Function to speak text
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                const selectedVoiceURI = voiceSelect.value;
                const voices = window.speechSynthesis.getVoices();
                const selectedVoice = voices.find(voice => voice.voiceURI === selectedVoiceURI);

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                } else {
                    utterance.lang = 'en-US';
                }
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn('Speech synthesis not supported in this browser.');
                updateMessage('Speech synthesis not supported in your browser.', true);
            }
        }

        // Function to populate voice options
        function populateVoiceList() {
            if ('speechSynthesis' in window) {
                const voices = window.speechSynthesis.getVoices();
                voiceSelect.innerHTML = '';

                let firstUSVoiceIndex = -1;

                voices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.value = voice.voiceURI;
                    option.lang = voice.lang;

                    voiceSelect.appendChild(option);

                    if (firstUSVoiceIndex === -1 && voice.lang.startsWith('en-US')) {
                        firstUSVoiceIndex = index;
                    }
                });

                if (firstUSVoiceIndex !== -1) {
                    voiceSelect.selectedIndex = firstUSVoiceIndex;
                } else if (voices.length > 0) {
                    voiceSelect.selectedIndex = 0;
                }
            } else {
                voiceSelect.innerHTML = '<option value="">Speech synthesis not supported</option>';
                voiceSelect.disabled = true;
            }
        }

        // Function to update the elapsed time display
        function updateTimerDisplay() {
            const now = Date.now();
            const elapsedMilliseconds = now - startTime;
            const totalSeconds = Math.floor(elapsedMilliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;

            const formattedMinutes = String(minutes).padStart(2, '0');
            const formattedSeconds = String(seconds).padStart(2, '0');

            timerDisplayDiv.textContent = `${formattedMinutes}:${formattedSeconds}`;
        }

        // Function to reset the timer
        function resetTimer() {
            startTime = Date.now();
            updateTimerDisplay();
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        // Event listener for when voices are loaded (important for async loading)
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = populateVoiceList;
            populateVoiceList();
        }

        // Initialize and start timer on page load
        resetTimer();

        // Event listener for the Generate button
        generateBtn.addEventListener('click', async () => {
            const prompt = promptInput.value.trim();
            const wordCount = wordCountSelect.value;
            const vocabularyLevel = vocabularyLevelSelect.value;

            if (!prompt) {
                updateMessage('Please enter a scenario prompt.', true);
                return;
            }

            updateMessage('Generating sentence...');
            scoreDisplayDiv.classList.add('hidden');
            generatedSentenceDiv.classList.add('hidden');
            currentSentence = '';

            currentScore += 100;
            generateCount++;

            try {
                // IMPORTANT: Replace "YOUR_API_KEY_HERE" with your actual Gemini API Key
                const apiKey = "AIzaSyByeYBULGd3mKTXb9QhkBaVUavpC7FtdWU"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                let llmPrompt = `Generate ONLY a single, concise sentence that sounds like a character speaking in a role-play scenario about "${prompt}". Make sure this sentence is distinctly different in its specific action, observation, or request from any previous potential ideas for this scenario. Explore various aspects and angles of the scenario. Do NOT include any introductory phrases like "Here is a sentence:" or "Here are a few options:". Ensure it is ${wordCount} words or less and uses a ${vocabularyLevel} vocabulary.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: llmPrompt }] });

                const payload = { contents: chatHistory };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error.message || response.statusText}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    let newSentence = result.candidates[0].content.parts[0].text.trim();
                    if (newSentence.startsWith('"') && newSentence.endsWith('"')) {
                        newSentence = newSentence.slice(1, -1);
                    }
                    newSentence = newSentence.replace(/[\r\n]+/g, ' ').trim();

                    const firstSentenceMatch = newSentence.match(/^[^.!?]*[.!?]?/);
                    if (firstSentenceMatch && firstSentenceMatch[0]) {
                        newSentence = firstSentenceMatch[0].trim();
                    } else {
                        newSentence = newSentence.trim();
                    }

                    currentSentence = newSentence;
                    speakText(currentSentence);
                    updateMessage('Sentence generated and spoken! Click "Show" to reveal it, or "Repeat" to hear it again.');
                    generatedSentenceDiv.textContent = currentSentence;

                } else {
                    updateMessage('Failed to generate a sentence. Please try again.', true);
                    console.error('Unexpected API response structure:', result);
                }

            } catch (error) {
                console.error('Error generating sentence:', error);
                updateMessage(`Error: ${error.message}. Please try again.`, true);
            }
        });

        // Event listener for the Repeat button
        repeatBtn.addEventListener('click', () => {
            if (currentSentence) {
                speakText(currentSentence);
                updateMessage('Repeating the last generated sentence.');
                currentScore -= 20;
                scoreDisplayDiv.classList.add('hidden');
            } else {
                updateMessage('No sentence to repeat. Click "Generate" first.', true);
            }
        });

        // Event listener for the Show button
        showBtn.addEventListener('click', () => {
            if (currentSentence) {
                generatedSentenceDiv.classList.remove('hidden');
                updateMessage('Here is the generated sentence.');
                currentScore = 0;
                scoreDisplayDiv.classList.add('hidden');
            } else {
                updateMessage('No sentence has been generated yet. Click "Generate" first.', true);
            }
        });

        // Event listener for the Score button
        scoreBtn.addEventListener('click', () => {
            let finalPercentage = 0;
            if (generateCount > 0) {
                const totalPossibleScore = generateCount * 100;
                finalPercentage = (currentScore / totalPossibleScore) * 100;
            }

            scoreDisplayDiv.innerHTML = `
                Current Points: <span class="font-bold">${currentScore}</span><br>
                Generates: <span class="font-bold">${generateCount}</span><br>
                Accuracy Score: <span class="font-bold text-lg">${finalPercentage.toFixed(2)}%</span>
            `;
            scoreDisplayDiv.classList.remove('hidden');
            updateMessage('Score calculated. Stats reset.');

            currentScore = 0;
            generateCount = 0;

            resetTimer(); // Reset and restart timer
        });
    </script>
</body>
</html>
